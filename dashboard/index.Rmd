---
title: "<b>Taller de Web Mapping con R - MasterGISDay</b>"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: simplex
    navbar:
        - { icon: "fa-twitter", href: "#", align: right}
        - { icon: "fa-linkedin", href: "#", align: right}
        - { icon: "fa-github", href: "#", align: right}
      
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(htmltools)
library(cptcity)
library(leaflet)
library(leaflet.extras)
library(sf)
library(echarts4r)
library(cptcity)
library(DT)
library(crosstalk)

```



Column {data-width=200}
-------------------------------------
### Decripci칩n

En este taller aprender치s los conceptos b치sicos que involocra a un GIS developer como as칤mismo las t칠cnolog칤as que est치n dentro del frontend y backend para el desarrollo de mapas webs.Finalmente se tocar치 aspectos generales de leaflet y derivados para el desarrollo de aplicaciones webs usando el lenguaje de programaci칩n R.

<br/>

游댮 Objetivos

Dar a conocer aspectos generales del webmapping.
Introducci칩n a HTML,CSS y JS
Mapas webs con leaflet y derivados dentro de R.

<br/>
<img src="https://raw.githubusercontent.com/ambarja/OsgeoLiveUNMSM/master/Sesi%C3%B3n01/img/avatar02.png" width="120px">
<br/>
<br/>
<p align='left'>
  <a href="https://www.linkedin.com/in/antonybarja/">
   <img src="https://img.shields.io/badge/LinkedIn-0077B5?style=for-the-badge&logo=linkedin&logoColor=white"></a> <a href="https://twitter.com/antony_barja"><img src="https://img.shields.io/badge/Twitter-1DA1F2?style=for-the-badge&logo=twitter&logoColor=white"></a> <a href="#"><img src="https://img.shields.io/badge/WebSite-%2312100E.svg?&style=for-the-badge&logo=github&logoColor=white"></a>  <a href="https://www.youtube.com/channel/UCuWvYTTYCZBmbDoEbsY2MSw"><img src="https://img.shields.io/badge/youtube-%23FF0000.svg?&style=for-the-badge&logo=youtube&logoColor=white"></a><a href="https://github.com/qgispe"><img src="https://img.shields.io/badge/qgis-peru-%233BB300.svg?&style=for-the-badge&logo=qgis&logoColor=white"></a> <a href="https://discord.gg/R5YtFxWbJr"><img src="https://img.shields.io/badge/Discord-7289DA?style=for-the-badge&logo=discord&logoColor=white"></a> <a href="https://www.buymeacoffee.com/ambarja"><img src="https://img.shields.io/badge/Buy_Me_A_Coffee-FFDD00?style=for-the-badge&logo=buy-me-a-coffee&logoColor=black" width="218px"></a>
</p>


Column
-----------------------------------------------------------------------

###  {data-height=900}

```{r echo=FALSE ,message=FALSE,warning=FALSE}
vacunas_geo <- read_csv(
  "https://www.datosabiertos.gob.pe/node/8298/download"
  ) %>%
  st_as_sf(
    coords = c("longitud","latitud"),
    crs = 4326
    ) %>%
  mutate(
    id = row_number()
    )

gpkg <- st_read(
  'https://github.com/ambarja/gpkg-pe/raw/main/Lima_distritos.gpkg',
   quiet = TRUE
  )


# 2.Preparaci칩n de datos --------------------------------------------------

lista_id <- st_contains(gpkg, vacunas_geo) %>% unlist()
vacunas_prov <- vacunas_geo %>%
  filter(id %in% lista_id)

vacunas_by_prov <- gpkg %>%
  select(NOMBPROV,NOMBDIST,CAPITAL) %>%
  mutate(
    total_cv = lapply(
      st_contains(gpkg,vacunas_geo),
      function(x){table(x) %>% sum}) %>% unlist()
    )

fill_color <- colorQuantile(
  palette = cpt(pal = 'cb_seq_Reds_05'),
  domain = vacunas_by_prov$total_cv,
  n = 5
  )

hex_color <- unique(fill_color(vacunas_by_prov$total_cv))
newlabels <- sprintf(
  '%s%s%s',
  round(lag(quantile(vacunas_by_prov$total_cv))),
  '-',
  round(quantile(vacunas_by_prov$total_cv))
  ) %>%
  str_replace(
    pattern = 'NA*',
    replacement = '0'
    )
logo <- tags$div(
  HTML(
    '<a href="#">
      <img border="0" src="https://user-images.githubusercontent.com/23284899/141409747-5f9da798-9cb0-46db-b750-f87dd1300a95.png" width="50" height="50">
    </a>')
)


# 3.Creacion de mapa web --------------------------------------------------
vacunas_by_prov %>%
  leaflet() %>%
  addProviderTiles(provider = providers$CartoDB.DarkMatter) %>%
  addPolygons(
    fillColor = ~fill_color(total_cv),
    fillOpacity = 0.9,
    weight = 0.5,
    color = 'white',
    dashArray = "3",
    label = sprintf(
      "%s%s%s",
      str_to_title(vacunas_by_prov$NOMBDIST),
      ":",
      vacunas_by_prov$total_cv),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"),
    highlightOptions = highlightOptions(
      weight = 5,
      color = "white",
      bringToFront = TRUE),
    ) %>%
  addLegend(
    position = 'topright',
    colors = hex_color,
    labels = newlabels,
    opacity = 1,
    title = 'Centros de <br/> vacunaci칩n'
    ) %>%
  addControl(logo,position = 'bottomleft') %>%
  addMiniMap(width = 100,height = 100,tiles = providers$CartoDB.DarkMatter) %>%
  addResetMapButton() %>%
  addSearchOSM() %>%
  setView(lng = -76.90,lat = -12.00 ,zoom = 9)





```


### 

```{r echo=FALSE}
vacunas_by_prov %>% 
  st_set_geometry(NULL) %>% 
   datatable(
     extensions = 'Buttons',
     options = list(
       dom = 'Blfrtip',
       buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
       scrollY = TRUE,
       pageLength = 2
       )
     )
```





